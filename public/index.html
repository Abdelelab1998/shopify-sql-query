<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopify SQL Query</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .mono { font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    .syntax-keyword { color: #7c3aed; font-weight: 600; }
    .syntax-function { color: #2563eb; }
    .syntax-table { color: #059669; }
    .syntax-string { color: #b45309; }
    .syntax-number { color: #dc2626; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Icon components
    const ShopifyLogo = (props) => (
      <svg {...props} viewBox="0 0 109.5 124.5" xmlns="http://www.w3.org/2000/svg">
        <path fill="#95BF47" d="M95.9,23.9c-0.1-0.6-0.6-1-1.1-1c-0.5,0-9.3-0.2-9.3-0.2s-7.4-7.2-8.1-7.9c-0.7-0.7-2.2-0.5-2.7-0.3 c0,0-1.4,0.4-3.7,1.1c-0.4-1.3-1-2.8-1.8-4.4c-2.6-5-6.5-7.7-11.1-7.7c0,0,0,0,0,0c-0.3,0-0.6,0-1,0.1c-0.1-0.2-0.3-0.3-0.4-0.5 c-2-2.2-4.6-3.2-7.7-3.1c-6,0.2-12,4.5-16.8,12.2c-3.4,5.4-6,12.2-6.8,17.5c-6.9,2.1-11.7,3.6-11.8,3.7c-3.5,1.1-3.6,1.2-4,4.5 c-0.3,2.5-9.5,73-9.5,73l76.4,13.2l33.1-8.2C109.5,115.8,96,24.5,95.9,23.9z M67.2,16.8c-1.8,0.5-3.8,1.2-5.9,1.8 c0-3-0.4-7.3-1.8-10.9C64,8.6,66.2,13.7,67.2,16.8z M57.2,19.9c-4,1.2-8.4,2.6-12.8,3.9c1.2-4.7,3.6-9.4,6.4-12.5 c1.1-1.1,2.6-2.4,4.3-3.2C56.9,11.6,57.3,16.5,57.2,19.9z M49.1,4c1.4,0,2.6,0.3,3.6,0.9C51.1,5.8,49.5,7,48,8.6 c-3.8,4.1-6.7,10.5-7.9,16.6c-3.6,1.1-7.2,2.2-10.5,3.2C31.7,18.8,39.8,4.3,49.1,4z"/>
        <path fill="#5E8E3E" d="M94.8,22.9c-0.5,0-9.3-0.2-9.3-0.2s-7.4-7.2-8.1-7.9c-0.3-0.3-0.6-0.4-1-0.5l0,109.7l33.1-8.2 c0,0-13.5-91.3-13.6-92C95.8,23.3,95.3,22.9,94.8,22.9z"/>
        <path fill="#FFFFFF" d="M58,39.9l-3.8,14.4c0,0-4.3-2-9.4-1.6c-7.5,0.5-7.5,5.2-7.5,6.4c0.4,6.4,17.3,7.8,18.3,22.9 c0.7,11.9-6.3,20-16.4,20.6c-12.2,0.8-18.9-6.4-18.9-6.4l2.6-11c0,0,6.7,5.1,12.1,4.7c3.5-0.2,4.8-3.1,4.7-5.1 c-0.5-8.4-14.3-7.9-15.2-21.7c-0.7-11.6,6.9-23.4,23.7-24.4C54.7,38.2,58,39.9,58,39.9z"/>
      </svg>
    );

    const TableIcon = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/>
      </svg>
    );

    const Search = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>);
    const AlertCircle = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="12"></line><line x1="12" x2="12.01" y1="16" y2="16"></line></svg>);
    const Book = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>);
    const Database = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5V19A9 3 0 0 0 21 19V5"></path><path d="M3 12A9 3 0 0 0 21 12"></path></svg>);
    const X = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>);
    const Store = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"></path><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"></path><path d="M2 7h20"></path></svg>);
    const Download = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>);
    const ChevronLeft = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>);
    const ChevronRight = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>);

    // Schema definition for autocomplete
    const schema = {
      tables: {
        orders: ['id', 'order_number', 'email', 'created_at', 'updated_at', 'total_price', 'subtotal_price', 'total_tax', 'total_shipping', 'total_discounts', 'total_refunded', 'currency', 'financial_status', 'fulfillment_status', 'note', 'tags', 'customer_id', 'customer_email', 'customer_first_name', 'customer_last_name', 'shipping_address1', 'shipping_city', 'shipping_province', 'shipping_country', 'shipping_zip', 'line_items_count'],
        order_line_items: ['id', 'order_id', 'order_number', 'title', 'quantity', 'sku', 'vendor', 'unit_price', 'discounted_price', 'variant_id', 'variant_title', 'product_id', 'product_title'],
        products: ['id', 'title', 'handle', 'description', 'vendor', 'product_type', 'tags', 'status', 'created_at', 'updated_at', 'published_at', 'total_inventory', 'min_price', 'max_price', 'currency', 'image_url', 'variants_count'],
        product_variants: ['id', 'product_id', 'product_title', 'title', 'sku', 'barcode', 'price', 'compare_at_price', 'inventory_quantity', 'available_for_sale', 'weight', 'weight_unit', 'options'],
        customers: ['id', 'email', 'first_name', 'last_name', 'full_name', 'phone', 'created_at', 'updated_at', 'note', 'tags', 'state', 'orders_count', 'total_spent', 'currency', 'city', 'province', 'country', 'zip'],
        collections: ['id', 'title', 'handle', 'description', 'sort_order', 'products_count', 'updated_at', 'image_url'],
        inventory_items: ['id', 'sku', 'tracked', 'created_at', 'updated_at', 'country_of_origin', 'variant_id', 'product_title'],
        inventory_levels: ['id', 'inventory_item_id', 'sku', 'location_id', 'location_name', 'available', 'product_title', 'variant_title'],
        locations: ['id', 'name', 'address1', 'city', 'province', 'country', 'zip', 'is_active', 'fulfills_online_orders'],
        draft_orders: ['id', 'name', 'email', 'created_at', 'status', 'total_price', 'customer_email'],
        shop: ['id', 'name', 'email', 'myshopify_domain', 'domain', 'currency', 'plan_name']
      },
      keywords: ['SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'ORDER BY', 'GROUP BY', 'HAVING', 'LIMIT', 'OFFSET', 'JOIN', 'LEFT JOIN', 'INNER JOIN', 'ON', 'AS', 'DISTINCT', 'COUNT', 'SUM', 'AVG', 'MIN', 'MAX', 'IN', 'NOT IN', 'LIKE', 'NOT LIKE', 'BETWEEN', 'IS NULL', 'IS NOT NULL', 'CASE', 'WHEN', 'THEN', 'ELSE', 'END', 'ASC', 'DESC', 'UNION', 'ALL'],
      functions: ['SHA2', 'MD5', 'LOWER', 'UPPER', 'CONCAT', 'SUBSTRING', 'TRIM', 'LENGTH', 'NOW', 'DATE', 'YEAR', 'MONTH', 'DAY', 'COALESCE', 'IFNULL', 'NULLIF', 'CAST', 'ROUND', 'ABS', 'FLOOR', 'CEIL']
    };

    const exampleQueries = [
      { sql: 'SELECT * FROM orders WHERE total_price > 100 ORDER BY created_at DESC LIMIT 50', desc: 'Recent high-value orders' },
      { sql: 'SELECT SHA2(LOWER(email), 256) AS email_hashed, total_spent FROM customers', desc: 'Hashed customer emails' },
      { sql: 'SELECT customer_email, COUNT(*) as order_count, SUM(total_price) as total FROM orders GROUP BY customer_email ORDER BY total DESC', desc: 'Customer order totals' },
      { sql: 'SELECT p.title, pv.sku, pv.price, pv.inventory_quantity FROM products p JOIN product_variants pv ON p.id = pv.product_id WHERE pv.inventory_quantity < 10', desc: 'Low stock variants' },
      { sql: 'SELECT DATE(created_at) as date, COUNT(*) as orders, SUM(total_price) as revenue FROM orders GROUP BY DATE(created_at) ORDER BY date DESC', desc: 'Daily sales report' },
      { sql: 'SELECT location_name, SUM(available) as total_stock FROM inventory_levels GROUP BY location_name', desc: 'Stock by location' },
      { sql: 'SELECT * FROM customers WHERE orders_count > 5 AND total_spent > 500 ORDER BY total_spent DESC', desc: 'VIP customers' },
      { sql: "SELECT title, vendor, total_inventory FROM products WHERE status = 'ACTIVE' AND total_inventory > 0", desc: 'Active products with stock' }
    ];

    const ShopifyQueryApp = () => {
      const [sqlQuery, setSqlQuery] = useState('');
      const [allResults, setAllResults] = useState(null);
      const [suggestions, setSuggestions] = useState([]);
      const [showSuggestions, setShowSuggestions] = useState(false);
      const [activeSuggestionIndex, setActiveSuggestionIndex] = useState(0);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [showDocs, setShowDocs] = useState(false);
      const [showConnect, setShowConnect] = useState(false);
      const [connected, setConnected] = useState(false);
      const [storeName, setStoreName] = useState('');
      const [connectionForm, setConnectionForm] = useState({ storeName: '', apiPassword: '' });
      const [isLoading, setIsLoading] = useState(true);
      const [connectLoading, setConnectLoading] = useState(false);
      const [currentPage, setCurrentPage] = useState(1);
      const [pageSize, setPageSize] = useState(10);
      const [showExportMenu, setShowExportMenu] = useState(false);
      const [queryTime, setQueryTime] = useState(null);
      const textareaRef = useRef(null);

      useEffect(() => { checkSession(); }, []);

      const checkSession = async () => {
        try {
          const response = await fetch('/api/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ action: 'checkSession' })
          });
          const data = await response.json();
          if (data.connected) {
            setConnected(true);
            setStoreName(data.storeName);
          }
        } catch (e) { console.warn('Session check failed:', e); }
        setIsLoading(false);
      };

      const totalPages = allResults ? Math.ceil(allResults.length / pageSize) : 0;
      const paginatedResults = allResults ? allResults.slice((currentPage - 1) * pageSize, currentPage * pageSize) : null;

      const updateSuggestions = (query, cursorPos) => {
        if (!query.trim()) { setShowSuggestions(false); return; }

        const beforeCursor = query.substring(0, cursorPos);
        const words = beforeCursor.split(/[\s,()]+/);
        const currentWord = words[words.length - 1].toLowerCase();
        const prevWord = (words[words.length - 2] || '').toLowerCase();
        
        if (currentWord.length < 1) { setShowSuggestions(false); return; }

        let newSuggestions = [];

        // Context-aware suggestions
        if (prevWord === 'from' || prevWord === 'join' || prevWord === 'into') {
          // Suggest tables
          newSuggestions = Object.keys(schema.tables)
            .filter(t => t.startsWith(currentWord))
            .map(t => ({ type: 'table', value: t, desc: `Table: ${schema.tables[t].length} columns` }));
        } else if (prevWord === 'by' || currentWord.includes('.')) {
          // Suggest columns after ORDER BY, GROUP BY, or table.column
          const tableName = currentWord.includes('.') ? currentWord.split('.')[0] : null;
          const colPrefix = currentWord.includes('.') ? currentWord.split('.')[1] : currentWord;
          
          if (tableName && schema.tables[tableName]) {
            newSuggestions = schema.tables[tableName]
              .filter(c => c.startsWith(colPrefix))
              .map(c => ({ type: 'column', value: `${tableName}.${c}`, desc: `Column in ${tableName}` }));
          } else {
            // Suggest all columns from detected tables
            const detectedTables = Object.keys(schema.tables).filter(t => 
              query.toLowerCase().includes(`from ${t}`) || query.toLowerCase().includes(`join ${t}`)
            );
            detectedTables.forEach(t => {
              schema.tables[t].filter(c => c.startsWith(currentWord))
                .forEach(c => newSuggestions.push({ type: 'column', value: c, desc: `Column in ${t}` }));
            });
          }
        } else {
          // General suggestions: keywords, functions, tables
          schema.keywords.filter(k => k.toLowerCase().startsWith(currentWord))
            .forEach(k => newSuggestions.push({ type: 'keyword', value: k, desc: 'SQL keyword' }));
          
          schema.functions.filter(f => f.toLowerCase().startsWith(currentWord))
            .forEach(f => newSuggestions.push({ type: 'function', value: f + '(', desc: 'SQL function' }));
          
          Object.keys(schema.tables).filter(t => t.startsWith(currentWord))
            .forEach(t => newSuggestions.push({ type: 'table', value: t, desc: 'Table' }));
        }

        // Add query templates
        if (currentWord.length > 2) {
          exampleQueries.filter(q => 
            q.sql.toLowerCase().includes(currentWord) || q.desc.toLowerCase().includes(currentWord)
          ).slice(0, 3).forEach(q => newSuggestions.push({ type: 'template', value: q.sql, desc: q.desc }));
        }

        const unique = newSuggestions.filter((s, i, arr) => arr.findIndex(t => t.value === s.value) === i);
        setSuggestions(unique.slice(0, 10));
        setShowSuggestions(unique.length > 0);
        setActiveSuggestionIndex(0);
      };

      const handleConnect = async () => {
        if (!connectionForm.storeName || !connectionForm.apiPassword) { alert('Please fill in all fields'); return; }
        setConnectLoading(true);
        setError('');
        try {
          const response = await fetch('/api/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ action: 'connect', credentials: connectionForm })
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error || 'Connection failed');
          setConnected(true);
          setStoreName(data.storeName);
          setShowConnect(false);
          setConnectionForm({ storeName: '', apiPassword: '' });
        } catch (err) { setError(err.message); }
        setConnectLoading(false);
      };

      const handleDisconnect = async () => {
        try {
          await fetch('/api/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ action: 'disconnect' })
          });
        } catch (e) {}
        setConnected(false);
        setStoreName('');
        setAllResults(null);
      };

      const executeQuery = async () => {
        if (!connected) { setError('Please connect your store first'); return; }
        if (!sqlQuery.trim()) { setError('Query cannot be empty'); return; }

        setLoading(true);
        setError('');
        const startTime = Date.now();
        
        try {
          const response = await fetch('/api/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ sql: sqlQuery })
          });
          const data = await response.json();
          if (!response.ok) {
            if (response.status === 401) { setConnected(false); setStoreName(''); }
            throw new Error(data.error || 'Query failed');
          }
          setAllResults(data.results);
          setCurrentPage(1);
          setQueryTime(Date.now() - startTime);
        } catch (err) { setError(err.message); setAllResults(null); }
        setLoading(false);
      };

      const handleSuggestionClick = (suggestion) => {
        if (suggestion.type === 'template') {
          setSqlQuery(suggestion.value);
        } else {
          const textarea = textareaRef.current;
          const cursorPos = textarea.selectionStart;
          const beforeCursor = sqlQuery.substring(0, cursorPos);
          const afterCursor = sqlQuery.substring(cursorPos);
          const words = beforeCursor.split(/[\s,()]+/);
          const currentWordStart = beforeCursor.lastIndexOf(words[words.length - 1]);
          const newQuery = sqlQuery.substring(0, currentWordStart) + suggestion.value + ' ' + afterCursor.trimStart();
          setSqlQuery(newQuery);
        }
        setShowSuggestions(false);
      };

      const handleKeyDown = (e) => {
        if (showSuggestions && suggestions.length > 0) {
          if (e.key === 'ArrowDown') { e.preventDefault(); setActiveSuggestionIndex(i => (i + 1) % suggestions.length); }
          else if (e.key === 'ArrowUp') { e.preventDefault(); setActiveSuggestionIndex(i => i > 0 ? i - 1 : suggestions.length - 1); }
          else if (e.key === 'Tab' || (e.key === 'Enter' && !e.metaKey && !e.ctrlKey)) {
            if (suggestions[activeSuggestionIndex]) { e.preventDefault(); handleSuggestionClick(suggestions[activeSuggestionIndex]); }
          }
          else if (e.key === 'Escape') { setShowSuggestions(false); }
        }
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) { e.preventDefault(); executeQuery(); }
      };

      const handleQueryChange = (e) => {
        const value = e.target.value;
        setSqlQuery(value);
        updateSuggestions(value, e.target.selectionStart);
      };

      // Export functions
      const exportToCSV = () => {
        if (!allResults?.length) return;
        const cols = Object.keys(allResults[0]);
        const csv = [cols.join(','), ...allResults.map(r => cols.map(c => {
          const v = r[c];
          return typeof v === 'string' && (v.includes(',') || v.includes('"')) ? `"${v.replace(/"/g, '""')}"` : v;
        }).join(','))].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `export_${Date.now()}.csv`;
        link.click();
        setShowExportMenu(false);
      };

      const exportToXLSX = () => {
        if (!allResults?.length) return;
        const ws = XLSX.utils.json_to_sheet(allResults);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Results');
        XLSX.writeFile(wb, `export_${Date.now()}.xlsx`);
        setShowExportMenu(false);
      };

      const exportToPDF = () => {
        if (!allResults?.length) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const cols = Object.keys(allResults[0]);
        doc.setFontSize(14);
        doc.text('Query Results', 14, 15);
        doc.setFontSize(8);
        doc.text(`${allResults.length} rows | ${new Date().toLocaleString()}`, 14, 22);
        doc.autoTable({
          head: [cols],
          body: allResults.map(r => cols.map(c => r[c])),
          startY: 28,
          styles: { fontSize: 7 },
          headStyles: { fillColor: [20, 184, 166] }
        });
        doc.save(`export_${Date.now()}.pdf`);
        setShowExportMenu(false);
      };

      const formatCell = (col, val) => {
        if (val == null) return <span className="text-gray-400 italic">null</span>;
        if (typeof val === 'number' && (col.includes('price') || col.includes('total') || col.includes('spent')))
          return `$${val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        if (col.includes('status')) {
          const colors = { PAID: 'bg-emerald-100 text-emerald-700', FULFILLED: 'bg-emerald-100 text-emerald-700', ACTIVE: 'bg-emerald-100 text-emerald-700', PENDING: 'bg-amber-100 text-amber-700', UNFULFILLED: 'bg-amber-100 text-amber-700', DRAFT: 'bg-gray-100 text-gray-700' };
          return <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${colors[val] || 'bg-gray-100 text-gray-700'}`}>{val}</span>;
        }
        if (typeof val === 'boolean') return val ? '✓' : '✗';
        return String(val).length > 100 ? String(val).substring(0, 100) + '...' : val;
      };

      const renderTable = () => {
        if (!paginatedResults?.length) return (
          <div className="text-center py-16"><Database className="w-12 h-12 mx-auto mb-3 text-gray-300" /><p className="text-sm text-gray-600">No results</p></div>
        );
        const cols = Object.keys(paginatedResults[0]);
        return (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50"><tr className="border-b border-gray-200">
                {cols.map(c => <th key={c} className="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase">{c.replace(/_/g, ' ')}</th>)}
              </tr></thead>
              <tbody>{paginatedResults.map((r, i) => (
                <tr key={i} className="border-b border-gray-100 hover:bg-gray-50">
                  {cols.map(c => <td key={c} className="py-3 px-4 text-sm text-gray-900">{formatCell(c, r[c])}</td>)}
                </tr>
              ))}</tbody>
            </table>
          </div>
        );
      };

      const renderPagination = () => {
        if (!allResults || allResults.length <= pageSize) return null;
        return (
          <div className="flex items-center justify-between px-4 py-3 border-t border-gray-200 bg-gray-50">
            <div className="flex items-center gap-2 text-sm text-gray-600">
              <span>Show</span>
              <select value={pageSize} onChange={e => { setPageSize(Number(e.target.value)); setCurrentPage(1); }}
                className="border border-gray-300 rounded px-2 py-1 text-sm">
                <option value={10}>10</option><option value={50}>50</option><option value={100}>100</option>
              </select>
              <span>of {allResults.length}</span>
            </div>
            <div className="flex items-center gap-1">
              <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className="p-1.5 rounded hover:bg-gray-200 disabled:opacity-50"><ChevronLeft className="w-4 h-4" /></button>
              <span className="px-3 py-1 text-sm">{currentPage} / {totalPages}</span>
              <button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} className="p-1.5 rounded hover:bg-gray-200 disabled:opacity-50"><ChevronRight className="w-4 h-4" /></button>
            </div>
          </div>
        );
      };

      if (isLoading) return (
        <div className="min-h-screen flex items-center justify-center">
          <div className="w-8 h-8 border-4 border-gray-200 border-t-teal-600 rounded-full animate-spin"></div>
        </div>
      );

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Header */}
          <div className="bg-white border-b border-gray-300">
            <div className="max-w-7xl mx-auto px-6 py-3.5 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <ShopifyLogo className="w-7 h-8" />
                <span className="text-gray-400">→</span>
                <TableIcon className="w-6 h-6 text-gray-700" />
                <h1 className="text-xl font-semibold text-gray-900">SQL Query</h1>
              </div>
              <div className="flex items-center gap-2">
                {connected ? (
                  <>
                    <div className="flex items-center gap-2 px-2.5 py-1.5 bg-teal-50 border border-teal-200 rounded text-teal-700">
                      <div className="w-1.5 h-1.5 bg-teal-500 rounded-full"></div>
                      <span className="text-xs font-medium">{storeName?.replace('.myshopify.com', '')}</span>
                    </div>
                    <button onClick={handleDisconnect} className="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50">Disconnect</button>
                  </>
                ) : (
                  <button onClick={() => setShowConnect(true)} className="flex items-center gap-1.5 px-3 py-1.5 bg-gray-900 text-white text-xs font-medium rounded hover:bg-gray-800">
                    <Store className="w-3.5 h-3.5" />Connect store
                  </button>
                )}
                <button onClick={() => setShowDocs(true)} className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50">
                  <Book className="w-3.5 h-3.5" />Docs
                </button>
              </div>
            </div>
          </div>

          {/* Connect Modal */}
          {showConnect && (
            <div className="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-6" onClick={() => setShowConnect(false)}>
              <div className="bg-white rounded-xl max-w-lg w-full shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="border-b px-6 py-4 flex items-center justify-between">
                  <h2 className="text-lg font-semibold">Connect to Shopify</h2>
                  <button onClick={() => setShowConnect(false)} className="p-1.5 hover:bg-gray-100 rounded-lg"><X className="w-5 h-5 text-gray-500" /></button>
                </div>
                <div className="px-6 py-6 space-y-5">
                  {error && <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">{error}</div>}
                  <div>
                    <label className="block text-sm font-semibold mb-2">Store name</label>
                    <input type="text" placeholder="your-store.myshopify.com" value={connectionForm.storeName}
                      onChange={e => setConnectionForm({...connectionForm, storeName: e.target.value})}
                      className="w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 mono" />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold mb-2">Admin API access token</label>
                    <input type="password" placeholder="shpat_xxxxx" value={connectionForm.apiPassword}
                      onChange={e => setConnectionForm({...connectionForm, apiPassword: e.target.value})}
                      className="w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 mono" />
                  </div>
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-xs text-blue-900">
                    <strong>Required scopes:</strong> read_orders, read_products, read_customers, read_inventory, read_locations
                  </div>
                  <button onClick={handleConnect} disabled={connectLoading}
                    className="w-full bg-gray-900 text-white py-3 rounded-lg text-sm font-semibold hover:bg-gray-800 disabled:opacity-50 flex items-center justify-center gap-2">
                    {connectLoading && <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>}
                    {connectLoading ? 'Connecting...' : 'Connect store'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Docs Modal */}
          {showDocs && (
            <div className="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-6" onClick={() => setShowDocs(false)}>
              <div className="bg-white rounded-lg max-w-5xl w-full max-h-[90vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="border-b px-8 py-6 flex items-center justify-between bg-white sticky top-0">
                  <div>
                    <h2 className="text-2xl font-semibold">SQL Documentation</h2>
                    <p className="text-gray-600 text-sm mt-1">Full SQL support with Shopify data</p>
                  </div>
                  <button onClick={() => setShowDocs(false)} className="p-2 hover:bg-gray-100 rounded-lg"><X className="w-5 h-5" /></button>
                </div>
                <div className="overflow-y-auto p-8 space-y-8" style={{ maxHeight: 'calc(90vh - 100px)' }}>
                  <section>
                    <h3 className="text-lg font-semibold mb-4">Available Tables</h3>
                    <div className="grid grid-cols-2 gap-3">
                      {Object.entries(schema.tables).map(([name, cols]) => (
                        <div key={name} className="border rounded-lg p-4 hover:border-teal-300">
                          <h4 className="font-semibold text-teal-700">{name}</h4>
                          <p className="text-xs text-gray-500 mt-1 mono">{cols.slice(0, 6).join(', ')}{cols.length > 6 ? '...' : ''}</p>
                        </div>
                      ))}
                    </div>
                  </section>
                  
                  <section>
                    <h3 className="text-lg font-semibold mb-4">SQL Functions</h3>
                    <div className="flex flex-wrap gap-2">
                      {schema.functions.map(f => (
                        <span key={f} className="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs mono">{f}()</span>
                      ))}
                    </div>
                  </section>
                  
                  <section>
                    <h3 className="text-lg font-semibold mb-4">Example Queries</h3>
                    <div className="space-y-3">
                      {exampleQueries.map((q, i) => (
                        <div key={i} className="border rounded-lg overflow-hidden">
                          <div className="bg-gray-50 px-4 py-2 text-sm font-medium">{q.desc}</div>
                          <pre className="bg-gray-900 text-green-400 p-4 text-sm overflow-x-auto mono">{q.sql}</pre>
                          <button onClick={() => { setSqlQuery(q.sql); setShowDocs(false); }}
                            className="w-full py-2 text-xs text-teal-600 hover:bg-teal-50">Use this query</button>
                        </div>
                      ))}
                    </div>
                  </section>
                </div>
              </div>
            </div>
          )}

          {/* Main */}
          <div className="max-w-7xl mx-auto px-6 py-6">
            {!connected && (
              <div className="mb-5 p-4 bg-yellow-50 border border-yellow-200 rounded-lg flex items-start gap-3">
                <AlertCircle className="w-5 h-5 text-yellow-600 flex-shrink-0" />
                <div>
                  <p className="text-sm font-semibold text-yellow-900">Store not connected</p>
                  <p className="text-sm text-yellow-800">Connect your Shopify store to run SQL queries.</p>
                </div>
              </div>
            )}

            {/* Query Editor */}
            <div className="mb-5">
              <div className="bg-white rounded border border-gray-300 shadow-sm">
                <div className="border-b px-4 py-2.5 bg-gray-50">
                  <label className="text-xs font-semibold text-gray-700 uppercase">SQL Query</label>
                </div>
                <div className="relative p-4">
                  <textarea
                    ref={textareaRef}
                    value={sqlQuery}
                    onChange={handleQueryChange}
                    onKeyDown={handleKeyDown}
                    onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
                    placeholder="SELECT * FROM orders WHERE total_price > 100 LIMIT 10"
                    className="w-full h-40 p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-gray-900 resize-none mono"
                    disabled={!connected}
                  />
                  {showSuggestions && suggestions.length > 0 && (
                    <div className="absolute z-10 left-4 right-4 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-64 overflow-y-auto">
                      {suggestions.map((s, i) => (
                        <button key={i} onMouseDown={() => handleSuggestionClick(s)} onMouseEnter={() => setActiveSuggestionIndex(i)}
                          className={`w-full text-left px-4 py-2.5 border-b border-gray-100 last:border-0 flex items-center justify-between ${i === activeSuggestionIndex ? 'bg-gray-100' : 'hover:bg-gray-50'}`}>
                          <div className="flex items-center gap-3">
                            <span className={`text-xs font-semibold px-2 py-0.5 rounded ${
                              s.type === 'keyword' ? 'bg-purple-100 text-purple-700' :
                              s.type === 'function' ? 'bg-blue-100 text-blue-700' :
                              s.type === 'table' ? 'bg-green-100 text-green-700' :
                              s.type === 'column' ? 'bg-orange-100 text-orange-700' :
                              'bg-gray-100 text-gray-700'
                            }`}>{s.type}</span>
                            <div>
                              <div className="text-sm font-medium mono">{s.value}</div>
                              <div className="text-xs text-gray-500">{s.desc}</div>
                            </div>
                          </div>
                          {i === activeSuggestionIndex && <kbd className="text-xs text-gray-400">Tab</kbd>}
                        </button>
                      ))}
                    </div>
                  )}
                </div>
                <div className="border-t px-4 py-2.5 bg-gray-50 flex items-center justify-between">
                  <div className="text-xs text-gray-500">
                    <kbd className="px-1.5 py-0.5 bg-white border rounded">⌘</kbd> + <kbd className="px-1.5 py-0.5 bg-white border rounded">Enter</kbd> to run
                    {queryTime && <span className="ml-4 text-teal-600">Query took {queryTime}ms</span>}
                  </div>
                  <button onClick={executeQuery} disabled={loading || !sqlQuery.trim() || !connected}
                    className="bg-teal-600 text-white py-2 px-4 rounded text-xs font-semibold hover:bg-teal-700 disabled:opacity-50 disabled:bg-gray-300 flex items-center gap-2">
                    {loading ? <div className="w-3.5 h-3.5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Search className="w-3.5 h-3.5" />}
                    {loading ? 'Running...' : 'Run query'}
                  </button>
                </div>
              </div>
              {error && !showConnect && (
                <div className="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg flex gap-2">
                  <AlertCircle className="w-4 h-4 text-red-600 flex-shrink-0" />
                  <p className="text-sm text-red-800 whitespace-pre-wrap">{error}</p>
                </div>
              )}
            </div>

            {/* Results */}
            <div className="bg-white border border-gray-300 rounded shadow-sm overflow-hidden">
              <div className="px-4 py-2.5 border-b bg-gray-50 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Database className="w-4 h-4 text-gray-600" />
                  <h3 className="text-xs font-semibold text-gray-700 uppercase">
                    {allResults ? `${allResults.length} results` : 'Results'}
                  </h3>
                </div>
                {allResults?.length > 0 && (
                  <div className="relative">
                    <button onClick={() => setShowExportMenu(!showExportMenu)}
                      className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50">
                      <Download className="w-3.5 h-3.5" />Export
                    </button>
                    {showExportMenu && (
                      <div className="absolute right-0 mt-1 w-36 bg-white border rounded-lg shadow-xl z-20">
                        <button onClick={exportToCSV} className="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50">CSV</button>
                        <button onClick={exportToXLSX} className="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50">Excel</button>
                        <button onClick={exportToPDF} className="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50">PDF</button>
                      </div>
                    )}
                  </div>
                )}
              </div>
              <div className="min-h-96">
                {allResults === null ? (
                  <div className="text-center py-16">
                    <Database className="w-12 h-12 mx-auto mb-3 text-gray-300" />
                    <p className="text-sm text-gray-600">Run a query to see results</p>
                  </div>
                ) : renderTable()}
              </div>
              {renderPagination()}
            </div>

            {/* Quick Reference */}
            <div className="mt-5 pt-5 border-t border-gray-300">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-xs font-semibold text-gray-700 uppercase">Available Tables</h3>
                <button onClick={() => setShowDocs(true)} className="text-xs text-teal-600 hover:underline">View full documentation</button>
              </div>
              <div className="flex flex-wrap gap-2">
                {Object.keys(schema.tables).map(t => (
                  <button key={t} onClick={() => setSqlQuery(`SELECT * FROM ${t} LIMIT 10`)}
                    className="px-3 py-1.5 bg-white border border-gray-300 rounded text-xs mono hover:border-teal-400 hover:bg-teal-50">{t}</button>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<ShopifyQueryApp />, document.getElementById('root'));
  </script>
</body>
</html>
